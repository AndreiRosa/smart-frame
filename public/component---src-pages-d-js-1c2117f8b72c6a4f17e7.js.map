{"version":3,"sources":["webpack:///./src/pages/d.js"],"names":["db","firebase","firestore","D","random","Math","floor","toString","padStart","alreadyActivated","localStorage","getItem","number","useState","isReady","setIsReady","activated","setActivated","useEffect","collection","doc","set","lastSeen","FieldValue","serverTimestamp","then","setItem","unsubscribe","onSnapshot","snap","deviceData","data","owner","delete"],"mappings":"iLAIMA,EAAKC,IAASC,YAsFLC,UApFL,WACR,IAAMC,EAASC,KAAKC,MAAoB,OAAdD,KAAKD,UAAiBG,WAAWC,SAAS,EAAG,KACjEC,IAAqBC,aAAaC,QAAQ,mBAAqBD,aAAaC,QAAQ,SACpFC,EAASF,aAAaC,QAAQ,iBAAmBP,EAHzC,EAIgBS,oBAAS,GAAhCC,EAJO,KAIEC,EAJF,OAKoBF,mBAASJ,GAApCO,EALO,KAKIC,EALJ,KA2Ed,OApEAC,qBAAU,WACJF,GACFhB,EACCmB,WAAW,gBACXC,IAAIR,GACJS,IAAI,CACHC,SAAUrB,IAASC,UAAUqB,WAAWC,oBAEzCC,MAAK,WACJf,aAAagB,QAAQ,eAAgBd,GACrCG,GAAW,QAId,CAACC,IAEJE,qBAAU,WACR,IAAIS,EAAc,KA6BlB,OA5BGb,IAAYE,IACbW,EAAc3B,EACXmB,WAAW,gBACXC,IAAIR,GACJgB,YAAW,SAAAC,GACV,IAAMC,EAAaD,EAAKE,OACrBD,GAAcA,EAAWE,OAC1BhC,EACGmB,WAAW,WACXC,IAAIU,EAAWE,OACfb,WAAW,WACXC,IAAIR,GACJS,IAAI,CACHL,WAAW,IAEZS,MAAK,WACJf,aAAagB,QAAQ,QAASI,EAAWE,OACzCf,GAAa,GACbjB,EACGmB,WAAW,WACXC,IAAIU,EAAWE,OACfC,SACAR,MAAK,sBAMb,WACFE,GAAaA,OAEjB,CAACb,EAASE,IAEbE,qBAAU,WACR,IAAIS,EAAc,KAWlB,OAVIX,IACFW,EAAc3B,EACXmB,WAAW,WACXC,IAAIV,aAAaC,QAAQ,UACzBQ,WAAW,WACXC,IAAIV,aAAaC,QAAQ,iBACzBiB,YAAW,SAAAC,QAIT,WACDF,GAAaA,QAKnB,kBAAC,IAAD,KACE,+CACEX,GAAa,4BAAKJ,IAClBI,GAAa","file":"component---src-pages-d-js-1c2117f8b72c6a4f17e7.js","sourcesContent":["import React, {useEffect, useState} from 'react'\r\nimport Layout from '../components/Layout'\r\nimport firebase from '../lib/firebase'\r\n\r\nconst db = firebase.firestore()\r\n\r\nconst D = () => {\r\n  const random = Math.floor(Math.random()*999999).toString().padStart(6, '0')\r\n  const alreadyActivated = !!localStorage.getItem('deviceNumber') && !!localStorage.getItem('owner')\r\n  const number = localStorage.getItem('deviceNumber') || random\r\n  const [isReady, setIsReady] = useState(false)\r\n  const [activated, setActivated] = useState(alreadyActivated)\r\n  \r\n  useEffect(() => {\r\n    if(!activated){\r\n      db \r\n      .collection('temp-devices')\r\n      .doc(number)\r\n      .set({\r\n        lastSeen: firebase.firestore.FieldValue.serverTimestamp()\r\n      })\r\n      .then(() => {\r\n        localStorage.setItem('deviceNumber', number)\r\n        setIsReady(true)\r\n      })\r\n    }\r\n    \r\n  }, [activated])\r\n\r\n  useEffect(() => {\r\n    let unsubscribe = null\r\n    if(isReady && !activated)\r\n      unsubscribe = db \r\n        .collection('temp-devices')\r\n        .doc(number)\r\n        .onSnapshot(snap => {\r\n          const deviceData = snap.data()\r\n          if(deviceData && deviceData.owner){\r\n            db\r\n              .collection('devices')\r\n              .doc(deviceData.owner)\r\n              .collection('devices')\r\n              .doc(number)\r\n              .set({\r\n                activated: true\r\n              })\r\n              .then(() => {\r\n                localStorage.setItem('owner', deviceData.owner)\r\n                setActivated(true)\r\n                db\r\n                  .collection('devices')\r\n                  .doc(deviceData.owner)\r\n                  .delete()\r\n                  .then(() => {\r\n                    \r\n                  })\r\n              })\r\n          }\r\n        })\r\n    return () => {\r\n      if(unsubscribe) unsubscribe()\r\n    }\r\n  }, [isReady, activated])\r\n\r\n  useEffect(() => {\r\n    let unsubscribe = null\r\n    if (activated){\r\n      unsubscribe = db \r\n        .collection('devices')\r\n        .doc(localStorage.getItem('owner'))\r\n        .collection('devices')\r\n        .doc(localStorage.getItem('deviceNumber'))\r\n        .onSnapshot(snap => {\r\n\r\n        }) \r\n    }\r\n    return () => {\r\n      if (unsubscribe) unsubscribe()\r\n    }\r\n  })\r\n\r\n  return(\r\n    <Layout>\r\n      <h1>PÃ¡gina Inicial</h1>\r\n      {!activated && <h2>{number}</h2>}\r\n      {!activated && <h2>Device already activated!</h2>}\r\n    </Layout>\r\n  )\r\n}\r\n\r\nexport default D"],"sourceRoot":""}